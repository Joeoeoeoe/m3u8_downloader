# m3u8网络视频下载器

## 项目简介

本项目基于 PyQt 实现了一个图形化的 m3u8 视频下载器，支持从网页或直接 m3u8 地址中爬取视频并下载。下载过程多线程加速，并保留每次下载日志，支持断点重试和多格式输出。



## 项目说明

- 本项目只针对m3u8的视频下载
- 会设置超时时间，并添加了失败列表；如果有资源没有被下载下来，会根据下载列表进行重试，如果连续10次都下载失败了，视为服务端资源受损，不再进行继续重试
- 支持打开代理的情况下进行下载



## 功能特性

- **图形化界面**：使用 PyQt 设计，操作简单直观  
- **地址规则解析**：支持通过特定的规则解析输入的地址字符串，实现多个视频的下载
- **多线程下载**：根据网速及配置自动分配线程  
- **下载日志**：以 JSON 格式保存在 `Data/` 目录，可重新加载或手动二次下载  
- **断点续传**：识别已有文件并自动重命名，避免重复覆盖  
- **搜索深度**：可自定义深度，支持隐藏资源探测和文本提取  
- **资源预测**：根据已发现的片段（如 `preview.m3u8`），自动尝试常见文件名（如 `index.m3u8` `mixed.m3u8`）  
- **多格式输出**：支持 MP4、MOV、AVI、M4A、FLV 等格式  
- **实时日志**：在主界面输出下载进度和失败重试信息  



## 配置说明

在设置面板中，可自定义以下参数：

| 选项           | 含义                                                         | 默认值     |
| :------------- | :----------------------------------------------------------- | :--------- |
| 存储目录       | 下载文件保存路径                                             | 程序根目录 |
| 默认文件名     | 未指定文件名时使用                                           | `output`   |
| 线程停止方式   | - 强制重启：立即终止并重启程序<br>- 阶段停止：设置标志位，优雅中断，缺点是需要一定的时间 | 强制重启   |
| 搜索深度 depth | 0–3，可控制重试次数、资源探测和递归搜索等；不选中表示深度0   | 2          |



### 搜索深度详解

| depth | 资源重加载次数 | 隐藏探测 | 文本提取 | 递归探测                     |
| ----- | -------------- | -------- | -------- | ---------------------------- |
| 0     | 3              | 否       | 否       | 无                           |
| 1     | 5              | 是       | 是       | 无                           |
| 2     | 3              | 是       | 是       | 无                           |
| 3     | 5              | 否       | 否       | 所有URL以 depth=2 的递归探测 |

- 资源重加载次数：在设定了超时时间的情况下可能出现资源加载不完全的情况，为了排除这一情况设计了重新加载次数（≠失败列表重试次数）
- 隐藏探测：根据配置，可能进行隐藏资源的探测——强制播放音视频标签、显示页面级别的隐藏元素、模拟页面滚动、模拟键盘点击等操作，进一步发现隐藏内容
- 文本提取：是否从响应文本中提取可能存在的m3u8视频地址


## 地址规则说明

- 示例1： `https://example.com/single_file` —— 不使用规则

- 示例2： `https://example.com/images/pic_{{idx}}.{{type}} {{idx:1-5}} {{type:jpg,m3u8,png}}` —— 
  - idx 指示数字范围；
  - type 指示列表列举

- 详细使用： [关于URL解析的解释](./URLDecode.md)

## 使用说明

- 多线程下载速度受网络影响较大，实测一部 2 小时的电影最快可在 10 秒内完成。

- 视频体积小不一定下载更快，因资源嗅探与分片重试耗时较长，短视频反而可能更耗时，属于正常现象。

### 使用示例

1. 在网页中搜索`哪吒2魔童闹海电影免费观看`
2. 点击进入第一个网站 `https://yqk5.cc/play/92204.html`

#### 下载方式1：

1. 直接拷贝刚刚的网址，并粘贴到下载器的网址栏中

4. 填写文件名
5. 开始下载
6. 根据日志发现：花费13s识别到了一个资源，共875个分片



![1](./screenshots/1.png)



![2](./screenshots/2.png)



#### 下载方式2：

1. 打开网页开发者工具，点击网络
2. 重新加载网页
3. 如图找到了index.m3u8，所以这个电影一定能用我的下载器进行下载
4. 拷贝刚刚的网址`https://hn.bfvvs.com/play/9avnA8ma/index.m3u8`
5. 在配置中关闭深度搜索
6. 粘贴网址到输入框

7. 直接点击开始下载

8. 观察发现由于么有填写文件名，所以使用了配置中的默认文件名`output`

   

   ![3](./screenshots/3.png)

   

   ![4](./screenshots/4.png)



## 安装与运行

1. 若需要进行手动编译，需要提前下载ffmpeg.exe并放到根目录下

2. 通过 `pyinstaller main_no_console.spec` 或者 `pyinstaller main_with_console.spec` 进行打包

3. 注意 spec 文件中 a.datas 中需要囊括的内容

## 已知问题

- **高并发风险**：大量线程可能导致 CPU/内存占用过高，极端情况下可能造成cpu和内存占用过高甚至线程分配达到上限导致出错，建议手动设置合适的并发数
- **生成失败**：部分机器下载成功后可能会视频组合失败，可进入 `m3u8` 文件夹，双击 `combine.bat` 手动合并



## 未来改进

- **异步改写**：将多线程替换为异步，提高资源利用效率
- **独立输出**：一次性多视频下载时，每次下载应当保存到独立子目录，避免日志或缓存覆盖
- **缓存清理**：当此爬取完成后进行统一的过程文件的销毁，避免过度占用存储空间
- **代理池**：通过模拟请求头，每次请求随机请求头，理论上难以被识别为爬虫软件；但是现在还无法避免封禁ip的反爬操作

- 范围爬取  url中支持一个范围
- 优化headers中的from-url