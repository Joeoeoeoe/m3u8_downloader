# M3U8 Monitor/Downloader Anti-Detection Redesign

## 1. 目标

本次改造不是“无限加深递归”，而是同时优化两件事：

1. 更稳定地拿到真实 `m3u8` 地址（采集阶段）。
2. 拿到地址后更高成功率下载分片（下载阶段）。

核心原则：

- 会话连续优先于随机伪装。
- 事件驱动优先于固定 `sleep`。
- 受控递归优先于全量递归。


## 2. 原实现的主要问题

### 2.1 采集阶段

- 触发动作大量依赖 `page.evaluate(...click...)`，部分站点会将其识别为“非真实用户交互”。
- 深度 3 的递归缺少预算和节点过滤，成本高、噪音大。
- 监测后没有把浏览器会话信息（cookie/referer/user-agent）传给下载阶段。

### 2.2 下载阶段

- 每个分片随机请求头会导致同一任务的指纹漂移（同 IP 同任务下 UA/请求特征频繁变化）。
- 重试轮次没有和“身份切换”“并发降级”联动。


## 3. 新设计（已落地）

## 3.1 采集链路（`MonitorM3U8.py`）

### A. 监听优先 + 触发补充

- 优先通过网络响应直接收集 `m3u8`。
- 在深度 2/3 下解析文本型响应，补抓被 JSON/脚本包裹的 `m3u8`。

### B. 真实交互优先

- 使用 Playwright 原生 `locator.click()` 触发常见播放器控件。
- 对主页面 + iframe 同时尝试。
- 仅保留少量必要脚本触发（`video.play()`），减少纯 JS 合成事件依赖。

### C. 受控递归

- 深度 3 不再递归所有 URL，而是递归“页面候选节点”。
- 加入预算：
  - 最多递归节点数 `max_nodes=8`
  - 跨站最多 `max_cross_site_nodes=2`
- 先同站点，后跨站点。

### D. 会话提示输出

监测阶段输出 `session_hints`，包含：

- `source_url`
- `final_url`
- `user_agent`
- `cookies`
- `referer_map`（发现的 m3u8 对应 referer）


## 3.2 下载链路（`DownloadM3U8.py`）

### A. Header 策略从“每片随机”改为“身份池 + 轮次轮换”

保留随机头价值，但调整使用方式：

- 任务开始时生成一个“小身份池”（默认 3 组）。
- 初始下载固定使用身份 0（稳定指纹）。
- 失败重试时按轮次切换身份（`identity 1 -> 2 -> 3 ...`）。

这样既有“混淆空间”，又不在单轮内制造明显漂移。

### B. 会话贯通

- 下载器支持接收 `session_hints`。
- 请求会自动注入：
  - 监测阶段 cookies
  - 对应 referer
  - 监测阶段 user-agent（优先作为身份 0）

### C. 封禁感知与并发降级

- 统计 `401/403/429` 失败。
- 在重试轮次中出现该类失败时，自动降低并发（下限 8）。


## 3.3 Worker 串联（`UI/MyWindow.py`）

- 监测模式下，`MonitorM3U8` 的 `session_hints` 会传入 `DownloadM3U8`。
- 直接输入 `m3u8` 时也会构造基础 hints（避免空 referer）。


## 4. 你关心的“随机 Header 是否有用”

结论：有用，但“使用方式”比“是否随机”更重要。

- 不推荐：每个分片都随机。
- 推荐：任务级稳定，重试轮次再切换身份。

原因：

- 站点会看“同一会话连续性”；每片随机会破坏会话一致性。
- 身份池轮换仍能提供一定混淆，但不会像原来那样明显异常。


## 5. 本次改动文件

- `MonitorM3U8.py`
  - 新增真实交互流程、受控递归、session hints。
- `DownloadM3U8.py`
  - 新增身份池策略、会话注入、封禁感知并发降级。
- `UI/MyWindow.py`
  - 将监测会话信息传递到下载器。


## 6. 建议的运行策略

1. 常规场景：`depth=2`，优先效率。
2. 难站点：`depth=3`，仅在确实需要跳转链路时使用。
3. 并发值不要一开始拉满，先中等并发验证后再提升。
4. 调试触发行为时可设置环境变量 `M3U8_MONITOR_HEADLESS=0`，用有界面模式观察真实点击与播放器响应。


## 7. 后续可继续增强（未在本次改动中实现）

- 增加“headless/headed 自动切换重试”开关。
- 把播放器触发策略拆成可配置 profile（Video.js / JWPlayer / DPlayer / xgplayer）。
- 将重试策略细分为：`429` 指数退避、`403` 身份切换、`5xx` 快速重试。
